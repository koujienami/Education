# 第7回現場で使えるAWS勉強会

### 今日やる事
****
**EC2、RDS、ELB、S3の環境を構築しながら、各種繋ぎこみとアプリケーションのデプロイ。**  

### 実施した学習内容
****
Railsアプリケーションのデプロイまで。  
今後の学習方針。自動化を重視して、他は一旦後回し。これは自動化部分がめちゃくちゃ難しい為。  
また自動化部分やCode as Infrastructureが理解できていないとAWSエンジニアとして仕事は出来ない為。  

### 理解したこと
****
Railsアプリケーションのデプロイに必要な作業。  
大量のハマりポイントとその解消方法。  
AWS上でのネットワークの設定(セキュリティグループの設定やポートの解放など)

### ハマった部分と解消方法
****
#### rake secretで生成するmasterkeyの取扱ミス
前回の作業時にローカルでrake secretを実施し、GitHubにコードをpushしていた。  
それをgit pullしてEC2上で作業していたが、production環境でのdb:create時に例外が発生した。  
これはrake secretで生成されているmasterkeyとEC2上にあるmasterkeyが不一致となり、credentialが復号出来ない為。  
その為、ローカルで実施して生成したmasterkeyをEC2環境にコピーすることで動作した。  
ちなみに参考サイトではEC2上でrake secretしているので参考サイト通りであれば問題は起きない。  
credentialにsecretkeyを張り付ける部分が有るため、ここで解決しているのだと誤解していたことにより発生。  

#### RDSへの接続設定が参考サイト上にない
これは参考サイト上のミス？っぽい。  
ローカルのMySQLに繋ぐ設定になってしまっていて、構築したRDSに繋がない。  
元々作っていたアプリでhost指定をしていたので、同様にhost指定を行って、接続確認を行った。

#### RDSに繋がらない
RDSをAWS上で立ち上げた直後からセキュリティグループの設定変更を行ったいなかった為、EC2から繋がらなかった。  
ポート開放する事により解決。

#### Unicorn起動して、nginxの起動で画面が出ない
問題点は二つ。一つ目はUnicornが起動しておらず、連係が出来ていなかった。  
連携後に確認しても表示されず、再度確認すると設定ファイルの不備がログ上にエラーで出ていた。  
設定ファイルのステータス確認をするとElasticIPを指定するnginxの設定で例外があった。  
参考サイトのものをそのままコピーしてしまうと「（」が付いており、これが設定ファイルで読み込まれてしまい例外となっていた。  
他、アプリケーションの名前を間違えており、フォルダが見つからないという例外も発生し、設定不備が多発。  
その後、nginx上で画面の確認が出来た。

#### アプリの画面が開かない
参考サイトにあるようにプリコンパイルが実施されていないことが原因。  
参考サイトではプリコンパイルが出来ていないと画像が出ない、という表示だったので無視していたのが原因(画像を使ってない為)  
実際にはUnicorn側のログを確認すると、プリコンパイルがされていない事によってアプリが表示できない旨が出ていた。  
プリコンパイルする事で解決。

#### その他
下記ハマりポイントの参考サイトにて解説。

### 参考サイト
****
#### AWSにアプリケーションデプロイまで
[(下準備編)世界一丁寧なAWS解説。EC2を利用して、RailsアプリをAWSにあげるまで](https://qiita.com/naoki_mochizuki/items/f795fe3e661a3349a7ce)  
[(DB・サーバー構築編)世界一丁寧なAWS解説。EC2を利用して、RailsアプリをAWSにあげるまで](https://qiita.com/naoki_mochizuki/items/22cfbf4bf7ec95f6ac1c)  
[(デプロイ編①)世界一丁寧なAWS解説。EC2を利用して、RailsアプリをAWSにあげるまで](https://qiita.com/naoki_mochizuki/items/814e0979217b1a25aa3e)  
[(デプロイ編②)世界一丁寧なAWS解説。EC2を利用して、RailsアプリをAWSにあげるまで](https://qiita.com/naoki_mochizuki/items/5a1757d222806cbe0cd1)  
[【AWS】S3まとめ](https://qiita.com/iron-breaker/items/f35c1d54887c434a321a)  

#### ハマりポイント
[受講者がハマったポイントと解決法](https://github.com/m-oka-system/aws-tutorial/blob/master/第7回/)  

#### GitHub
[Ruby on RailsでWebアプリ作成](https://github.com/koujienami/TimeLine)